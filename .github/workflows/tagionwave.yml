name: Test Tagionwave
on: 
  workflow_dispatch:
    #    inputs:
    #      logLevel:
    #        description: 'Log level'
    #        required: true
    #        default: 'warning'
    #        type: choice
    #        options:
    #          - info
    #          - warning
    #          - debug
    #      print_tags:
    #        description: 'True to print to STDOUT'
    #        required: true
    #        type: boolean
    #      tags:
    #        description: 'Test scenario tags'
    #        required: true
    #        type: string
    #      environment:
    #        description: 'Environment to run tests against'
    #        type: environment
    #        required: true

jobs:
  deploy_tagionwave:
    runs-on: testnet
    environment: 
      name: testnet-mobile
      url: 10.210.2.10

    steps:
      - name: Backup old data
        run: |
          DIR_EPOCH=stat -c%W ~/.local/share/tagion && \
          OLD_DIR_NAME=~/.local/share/tagion_$(date -d @$DIR_EPOCH +%F_%H:%M) && \
          mv ~/.local/share/tagion $OLD_DIR_NAME || \
          echo "No old data to backup"

      - name: get artifact
        run: |
          rm -rf *
          loginctl enable-linger moonbase
          gh run download -n successful_artifact --repo tagion/tagion
          tar -xzf *.tar.gz

      - name: Initialize network bills
        run: |
          cd build/x86_64-linux/bin
          ./tagion -s
          ./create_wallets_2.sh -b $PWD -k ~/.local/share/tagion/wave -t ~/.local/share/tagion/wallets -w 5 -n 5

      - name: start service
        run: |
          cd build/x86_64-linux/bin
          export DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1001/bus
          export XDG_RUNTIME_DIR=/run/user/1001
          systemctl stop --user neuewelle.service | echo "No wave service was running"
          systemctl stop --user tagionshell.service | echo "No shell service was running"
          mkdir -p ~/.local/share/bin
          mkdir -p ~/.config/systemd/user
          cp tagion ~/.local/share/bin/
          echo "Deploying revision" >> $GITHUB_STEP_SUMMARY
          ~/.local/share/bin/tagion --version >> $GITHUB_STEP_SUMMARY
          cp tagionshell.service neuewelle.service ~/.config/systemd/user
          systemctl --user daemon-reload
          systemctl restart --user neuewelle.service
          systemctl restart --user tagionshell.service
