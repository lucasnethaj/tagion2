name: Commit Build and Test
on:
  workflow_dispatch:
  push: 
    branches: 
      - current
env:
  TARGET: x86_64-linux
  STAGE: commit
  DC: dmd
  PARALLEL: 2
  RETENTION_DAYS_BINS: 3

jobs:
  build_and_test:
    runs-on: phillip
    steps:
      - name: pull
        run: |
          git checkout current
          git pull
          git pull 
# make it work with recursive submodules

      - name: Run tests
        run: |
          make test -j ${{env.PARALLEL}} DC=${{env.DC}} || make proper test -j ${{env.PARALLEL}} DC=${{env.DC}}
          
      - name: Report unittests
        run: |
          RESULT=$(cat logs/${{ env.TARGET }}/unittest.log | grep -E "^[0-9]+ modules passed unittests")
          echo -e "### :heavy_check_mark: Unittests passed \n $RESULT" >> $GITHUB_STEP_SUMMARY

      - name: Report bddtests
        run: | 
          RESULT=$(./build/${{ env.TARGET }}/bin/collider -c logs/${{ env.TARGET }}/bdd/${{ env.STAGE }}/results)
          echo $RESULT | grep "Test result success!"
          echo -e "\n $RESULT" >> $GITHUB_STEP_SUMMARY

      - name: Create tar ball
        run: |
          commit_hash=$(git rev-parse HEAD)
          timestamp=$(date +%M-%H-%d-%m-%y)
          tar_filename="${commit_hash}-${timestamp}.tar.gz"
          tar -czf ../${tar_filename} --exclude='*.o' logs/ build/
          echo -e "\nRelease candidate is: $tar_filename" >> $GITHUB_STEP_SUMMARY
          gh workflow run acceptance.yml -f tarball=$tar_filename

      - name: Upload all
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: failed-run
          path: $tar_filename
          retention-days: ${{ env.RETENTION_DAYS_BINS }}
      # - name: Move tar ball to shared storage

        env:
          GITHUB_TOKEN: ${{ secrets.BOT_TOKEN }}
 
